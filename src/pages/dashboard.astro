---
import Layout from "../layouts/Layout.astro";
import AppLayout from "../layouts/AppLayout.svelte";
import SetsDashboard from "../components/SetsDashboard.svelte";
import AccountButton from "../components/AccountButton.svelte";
import { getUserId } from "../lib/auth/get-user-id";
import type { SetListResponse } from "../types";

// SSR Guard - check authentication
const result = await getUserId(Astro.locals.supabase);
if (!result.success) {
  return Astro.redirect("/login");
}

// Fetch sets data
let setsData: SetListResponse;
try {
  const response = await fetch(`${Astro.url.origin}/api/sets`, {
    headers: {
      cookie: Astro.request.headers.get("cookie") || "",
    },
  });

  if (response.status === 401) {
    return Astro.redirect("/login");
  }

  if (!response.ok) {
    // Handle other errors - could redirect to error page
    console.error("Failed to fetch sets:", response.statusText);
    return Astro.redirect("/error");
  }

  setsData = await response.json();
} catch (error) {
  console.error("Error fetching sets:", error);
  return Astro.redirect("/error");
}
---

<Layout title="Dashboard - Tabliczki ZTM">
  <AppLayout client:load>
    <AccountButton slot="header-left" client:load />

    <SetsDashboard initialSets={setsData.sets} totalCount={setsData.total_count} client:load />
  </AppLayout>
</Layout>
