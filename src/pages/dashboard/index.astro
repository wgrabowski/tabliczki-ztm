---
import Layout from "../../layouts/Layout.astro";
import AppLayout from "../../layouts/AppLayout.svelte";
import SetsDashboard from "../../components/SetsDashboard.svelte";
import AccountButton from "../../components/AccountButton.svelte";
import { getUserId } from "../../lib/auth/get-user-id";
import type { SetListResponse } from "../../types";

// Disable prerendering - this page requires dynamic data
export const prerender = false;

// SSR Guard - check authentication
const result = await getUserId(Astro.locals.supabase);
if (!result.success) {
  const returnUrl = `${Astro.url.pathname}${Astro.url.search}`;
  return Astro.redirect(`/auth/login?returnUrl=${encodeURIComponent(returnUrl)}`);
}

// Fetch sets data
let setsData: SetListResponse;
try {
  const response = await fetch(`${Astro.url.origin}/api/sets?t=${Date.now()}`, {
    headers: {
      cookie: Astro.request.headers.get("cookie") || "",
      "Cache-Control": "no-cache, no-store, must-revalidate",
      Pragma: "no-cache",
    },
  });

  if (response.status === 401) {
    const returnUrl = `${Astro.url.pathname}${Astro.url.search}`;
    return Astro.redirect(`/auth/login?returnUrl=${encodeURIComponent(returnUrl)}`);
  }

  if (!response.ok) {
    // Handle other errors - could redirect to error page
    console.error("Failed to fetch sets:", response.statusText);
    return Astro.redirect("/error");
  }

  setsData = await response.json();
} catch (error) {
  console.error("Error fetching sets:", error);
  return Astro.redirect("/error");
}
---

<Layout title="Dashboard - Tabliczki ZTM">
  <AppLayout client:load>
    <AccountButton slot="header-left" client:load />

    <SetsDashboard initialSets={setsData.sets} totalCount={setsData.total_count} client:load />
  </AppLayout>
</Layout>
